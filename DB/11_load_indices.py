"""
반도체 산업 관련 외부 지수 데이터 생성 & Supabase 적재
기존 economic_indicator 테이블에 추가 적재 (source별 구분)

생성 지표:
  [MARKET] SOX           — 필라델피아 반도체 지수 (일간)
  [MARKET] DRAM_DDR4     — DRAM DDR4 8Gb 현물가격 (주간)
  [MARKET] NAND_TLC      — NAND Flash 128Gb TLC 현물가격 (주간)
  [MARKET] SILICON_WAFER — 실리콘 웨이퍼 300mm ASP (월간)
  [MARKET] BALTIC_DRY    — 발틱운임지수 (일간)
  [MARKET] COPPER_LME    — 구리 LME 가격 (일간)
  [BOK]    KR_BASE_RATE  — 한국 기준금리 (월간)
  [BOK]    KR_CPI        — 한국 소비자물가지수 (월간)
  [BOK]    KR_IPI_MFG    — 한국 제조업 생산지수 (월간)
  [CHINA]  CN_PMI_MFG    — 중국 차이신 제조업 PMI (월간)

실행: python DB/11_load_indices.py
옵션: --only=sox,dram,kr_base_rate   (특정 지표만)
"""

import io
import os
import sys
import time
import random
from datetime import datetime, date, timedelta

sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding="utf-8", errors="replace")
sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding="utf-8", errors="replace")

try:
    from supabase import create_client, Client
except ImportError:
    print("supabase 패키지가 필요합니다: pip install supabase")
    sys.exit(1)

from dotenv import load_dotenv

load_dotenv()

SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_SERVICE_ROLE_KEY")

if not SUPABASE_URL or not SUPABASE_KEY:
    print("ERROR: .env에 SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY 필요")
    sys.exit(1)

supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

BATCH_SIZE = 500
MAX_RETRIES = 3
START_DATE = date(2021, 1, 1)
END_DATE = date(2026, 2, 28)

random.seed(42)


# ── 공통 함수 ──────────────────────────────────────────
def upsert_batch(table_name: str, rows: list, on_conflict: str = None) -> int:
    if not rows:
        return 0
    for attempt in range(MAX_RETRIES):
        try:
            if on_conflict:
                supabase.table(table_name).upsert(rows, on_conflict=on_conflict).execute()
            else:
                supabase.table(table_name).upsert(rows).execute()
            return len(rows)
        except Exception as e:
            err = str(e)
            if attempt < MAX_RETRIES - 1 and ("502" in err or "504" in err or "rate" in err.lower()):
                wait = (attempt + 1) * 5
                print(f"    >> 재시도 {attempt+2}/{MAX_RETRIES} ({wait}s 대기)")
                time.sleep(wait)
            else:
                raise
    return 0


def is_weekday(d: date) -> bool:
    return d.weekday() < 5


def interpolate(target: date, anchors: list[tuple[date, float]]) -> float:
    if target <= anchors[0][0]:
        return anchors[0][1]
    if target >= anchors[-1][0]:
        return anchors[-1][1]
    for i in range(len(anchors) - 1):
        d1, v1 = anchors[i]
        d2, v2 = anchors[i + 1]
        if d1 <= target <= d2:
            total = (d2 - d1).days
            elapsed = (target - d1).days
            if total == 0:
                return v1
            return v1 + (v2 - v1) * (elapsed / total)
    return anchors[-1][1]


def anchors_to_list(anchors_dict: dict) -> list[tuple[date, float]]:
    """월별 앵커 딕셔너리 → (date, value) 정렬 리스트"""
    result = []
    for ym, val in sorted(anchors_dict.items()):
        y, m = int(ym[:4]), int(ym[5:7])
        result.append((date(y, m, 15), val))
    return result


def generate_daily(anchors_dict: dict, noise_pct: float) -> list[tuple[date, float]]:
    """영업일 일간 데이터 생성"""
    anchor_list = anchors_to_list(anchors_dict)
    results = []
    d = START_DATE
    while d <= END_DATE:
        if is_weekday(d):
            val = interpolate(d, anchor_list)
            val += random.gauss(0, abs(val) * noise_pct)
            results.append((d, round(val, 4)))
        d += timedelta(days=1)
    return results


def generate_weekly(anchors_dict: dict, noise_pct: float) -> list[tuple[date, float]]:
    """매주 월요일 데이터 생성"""
    anchor_list = anchors_to_list(anchors_dict)
    results = []
    d = START_DATE
    # 첫 번째 월요일 찾기
    while d.weekday() != 0:
        d += timedelta(days=1)
    while d <= END_DATE:
        val = interpolate(d, anchor_list)
        val += random.gauss(0, abs(val) * noise_pct)
        results.append((d, round(val, 4)))
        d += timedelta(days=7)
    return results


def generate_monthly(anchors_dict: dict, noise_pct: float) -> list[tuple[date, float]]:
    """매월 1일 데이터 생성"""
    anchor_list = anchors_to_list(anchors_dict)
    results = []
    y, m = START_DATE.year, START_DATE.month
    while True:
        d = date(y, m, 1)
        if d > END_DATE:
            break
        val = interpolate(d, anchor_list)
        val += random.gauss(0, abs(val) * noise_pct)
        results.append((d, round(val, 4)))
        m += 1
        if m > 12:
            m = 1
            y += 1
    return results


def generate_stepwise_monthly(rate_changes: list[tuple[str, float]]) -> list[tuple[date, float]]:
    """단계적 변동 지표 (기준금리 등) — 변경 시점 사이 값 유지"""
    # rate_changes: [("2021-01", 0.50), ("2021-08", 0.75), ...]
    changes = [(date(int(ym[:4]), int(ym[5:7]), 1), val) for ym, val in rate_changes]
    results = []
    y, m = START_DATE.year, START_DATE.month
    while True:
        d = date(y, m, 1)
        if d > END_DATE:
            break
        val = changes[0][1]
        for cd, cv in changes:
            if d >= cd:
                val = cv
        results.append((d, val))
        m += 1
        if m > 12:
            m = 1
            y += 1
    return results


def load_indicator(code: str, source: str, name: str, unit: str,
                   data: list[tuple[date, float]]) -> int:
    """economic_indicator 테이블에 적재"""
    rows = []
    for d, val in data:
        rows.append({
            "source": source,
            "indicator_code": code,
            "indicator_name": name,
            "date": d.isoformat(),
            "value": val,
            "unit": unit,
        })

    count = 0
    for i in range(0, len(rows), BATCH_SIZE):
        batch = rows[i:i + BATCH_SIZE]
        count += upsert_batch("economic_indicator", batch,
                              on_conflict="source,indicator_code,date")
        time.sleep(0.3)
    return count


# ══════════════════════════════════════════════════════════
# 지표별 앵커 데이터 (실제 시세 기반 근사값)
# ══════════════════════════════════════════════════════════

# ── 1. SOX: 필라델피아 반도체 지수 (일간) ──────────────
SOX_ANCHORS = {
    "2021-01": 3050, "2021-02": 3100, "2021-03": 2980,
    "2021-04": 3200, "2021-05": 3100, "2021-06": 3300,
    "2021-07": 3350, "2021-08": 3450, "2021-09": 3250,
    "2021-10": 3550, "2021-11": 3750, "2021-12": 3900,
    "2022-01": 3600, "2022-02": 3350, "2022-03": 3200,
    "2022-04": 2900, "2022-05": 2800, "2022-06": 2500,
    "2022-07": 2650, "2022-08": 2550, "2022-09": 2300,
    "2022-10": 2250, "2022-11": 2700, "2022-12": 2500,
    "2023-01": 2800, "2023-02": 2900, "2023-03": 3000,
    "2023-04": 3100, "2023-05": 3500, "2023-06": 3650,
    "2023-07": 3750, "2023-08": 3500, "2023-09": 3350,
    "2023-10": 3200, "2023-11": 3800, "2023-12": 4000,
    "2024-01": 4200, "2024-02": 4600, "2024-03": 4900,
    "2024-04": 4700, "2024-05": 5100, "2024-06": 5300,
    "2024-07": 5100, "2024-08": 4800, "2024-09": 5100,
    "2024-10": 5000, "2024-11": 4900, "2024-12": 5100,
    "2025-01": 4800, "2025-02": 4600, "2025-03": 4400,
    "2025-04": 4300, "2025-05": 4500, "2025-06": 4600,
    "2025-07": 4700, "2025-08": 4800, "2025-09": 4750,
    "2025-10": 4850, "2025-11": 4900, "2025-12": 5000,
    "2026-01": 5050, "2026-02": 5100,
}

# ── 2. DRAM DDR4 8Gb 현물가격 (주간, USD) ─────────────
DRAM_ANCHORS = {
    "2021-01": 3.70, "2021-02": 4.10, "2021-03": 4.50,
    "2021-04": 4.80, "2021-05": 5.10, "2021-06": 5.00,
    "2021-07": 4.70, "2021-08": 4.40, "2021-09": 4.10,
    "2021-10": 3.80, "2021-11": 3.50, "2021-12": 3.20,
    "2022-01": 3.10, "2022-02": 3.00, "2022-03": 2.80,
    "2022-04": 2.70, "2022-05": 2.60, "2022-06": 2.40,
    "2022-07": 2.20, "2022-08": 2.00, "2022-09": 1.80,
    "2022-10": 1.60, "2022-11": 1.50, "2022-12": 1.40,
    "2023-01": 1.30, "2023-02": 1.20, "2023-03": 1.15,
    "2023-04": 1.10, "2023-05": 1.20, "2023-06": 1.40,
    "2023-07": 1.60, "2023-08": 1.80, "2023-09": 2.00,
    "2023-10": 2.30, "2023-11": 2.60, "2023-12": 3.00,
    "2024-01": 3.30, "2024-02": 3.60, "2024-03": 4.00,
    "2024-04": 4.30, "2024-05": 4.50, "2024-06": 4.60,
    "2024-07": 4.40, "2024-08": 4.20, "2024-09": 3.80,
    "2024-10": 3.50, "2024-11": 3.20, "2024-12": 3.00,
    "2025-01": 2.80, "2025-02": 2.70, "2025-03": 2.60,
    "2025-04": 2.50, "2025-05": 2.60, "2025-06": 2.70,
    "2025-07": 2.80, "2025-08": 2.90, "2025-09": 3.00,
    "2025-10": 3.10, "2025-11": 3.20, "2025-12": 3.30,
    "2026-01": 3.40, "2026-02": 3.50,
}

# ── 3. NAND Flash 128Gb TLC 현물가격 (주간, USD) ──────
NAND_ANCHORS = {
    "2021-01": 4.20, "2021-02": 4.40, "2021-03": 4.50,
    "2021-04": 4.60, "2021-05": 4.70, "2021-06": 4.50,
    "2021-07": 4.30, "2021-08": 4.10, "2021-09": 3.90,
    "2021-10": 3.70, "2021-11": 3.50, "2021-12": 3.40,
    "2022-01": 3.30, "2022-02": 3.20, "2022-03": 3.10,
    "2022-04": 3.00, "2022-05": 2.90, "2022-06": 2.70,
    "2022-07": 2.50, "2022-08": 2.30, "2022-09": 2.10,
    "2022-10": 1.90, "2022-11": 1.80, "2022-12": 1.70,
    "2023-01": 1.60, "2023-02": 1.50, "2023-03": 1.45,
    "2023-04": 1.40, "2023-05": 1.45, "2023-06": 1.55,
    "2023-07": 1.70, "2023-08": 1.85, "2023-09": 2.00,
    "2023-10": 2.20, "2023-11": 2.40, "2023-12": 2.60,
    "2024-01": 2.80, "2024-02": 3.00, "2024-03": 3.30,
    "2024-04": 3.50, "2024-05": 3.60, "2024-06": 3.70,
    "2024-07": 3.50, "2024-08": 3.30, "2024-09": 3.10,
    "2024-10": 2.90, "2024-11": 2.70, "2024-12": 2.60,
    "2025-01": 2.50, "2025-02": 2.40, "2025-03": 2.35,
    "2025-04": 2.30, "2025-05": 2.35, "2025-06": 2.40,
    "2025-07": 2.50, "2025-08": 2.55, "2025-09": 2.60,
    "2025-10": 2.70, "2025-11": 2.75, "2025-12": 2.80,
    "2026-01": 2.85, "2026-02": 2.90,
}

# ── 4. 실리콘 웨이퍼 300mm ASP (월간, USD) ────────────
WAFER_ANCHORS = {
    "2021-01": 4.45, "2021-02": 4.48, "2021-03": 4.52,
    "2021-04": 4.58, "2021-05": 4.65, "2021-06": 4.72,
    "2021-07": 4.80, "2021-08": 4.88, "2021-09": 4.95,
    "2021-10": 5.02, "2021-11": 5.10, "2021-12": 5.18,
    "2022-01": 5.25, "2022-02": 5.32, "2022-03": 5.40,
    "2022-04": 5.48, "2022-05": 5.55, "2022-06": 5.62,
    "2022-07": 5.68, "2022-08": 5.72, "2022-09": 5.75,
    "2022-10": 5.77, "2022-11": 5.78, "2022-12": 5.78,
    "2023-01": 5.75, "2023-02": 5.72, "2023-03": 5.68,
    "2023-04": 5.62, "2023-05": 5.55, "2023-06": 5.48,
    "2023-07": 5.42, "2023-08": 5.35, "2023-09": 5.30,
    "2023-10": 5.25, "2023-11": 5.22, "2023-12": 5.20,
    "2024-01": 5.18, "2024-02": 5.15, "2024-03": 5.15,
    "2024-04": 5.18, "2024-05": 5.22, "2024-06": 5.28,
    "2024-07": 5.35, "2024-08": 5.42, "2024-09": 5.48,
    "2024-10": 5.52, "2024-11": 5.55, "2024-12": 5.58,
    "2025-01": 5.60, "2025-02": 5.62, "2025-03": 5.65,
    "2025-04": 5.68, "2025-05": 5.70, "2025-06": 5.72,
    "2025-07": 5.75, "2025-08": 5.78, "2025-09": 5.80,
    "2025-10": 5.82, "2025-11": 5.85, "2025-12": 5.88,
    "2026-01": 5.90, "2026-02": 5.92,
}

# ── 5. 발틱운임지수 BDI (일간) ─────────────────────────
BALTIC_DRY_ANCHORS = {
    "2021-01": 1700, "2021-02": 1650, "2021-03": 2100,
    "2021-04": 2600, "2021-05": 3100, "2021-06": 3300,
    "2021-07": 3400, "2021-08": 3800, "2021-09": 4200,
    "2021-10": 5500, "2021-11": 2900, "2021-12": 2300,
    "2022-01": 1800, "2022-02": 2100, "2022-03": 2600,
    "2022-04": 2400, "2022-05": 2900, "2022-06": 2400,
    "2022-07": 2100, "2022-08": 1600, "2022-09": 1700,
    "2022-10": 1800, "2022-11": 1500, "2022-12": 1300,
    "2023-01": 1000, "2023-02": 700,  "2023-03": 1400,
    "2023-04": 1500, "2023-05": 1200, "2023-06": 1100,
    "2023-07": 1200, "2023-08": 1100, "2023-09": 1500,
    "2023-10": 1800, "2023-11": 2400, "2023-12": 2500,
    "2024-01": 1800, "2024-02": 1600, "2024-03": 1800,
    "2024-04": 1900, "2024-05": 2000, "2024-06": 1900,
    "2024-07": 1800, "2024-08": 1700, "2024-09": 1950,
    "2024-10": 1700, "2024-11": 1400, "2024-12": 1100,
    "2025-01": 900,  "2025-02": 800,  "2025-03": 1100,
    "2025-04": 1300, "2025-05": 1400, "2025-06": 1350,
    "2025-07": 1500, "2025-08": 1400, "2025-09": 1550,
    "2025-10": 1600, "2025-11": 1500, "2025-12": 1300,
    "2026-01": 1200, "2026-02": 1100,
}

# ── 6. 구리 LME 가격 (일간, USD/ton) ──────────────────
COPPER_LME_ANCHORS = {
    "2021-01": 7900, "2021-02": 8600, "2021-03": 9050,
    "2021-04": 9500, "2021-05": 10200, "2021-06": 9500,
    "2021-07": 9400, "2021-08": 9300, "2021-09": 9150,
    "2021-10": 9700, "2021-11": 9700, "2021-12": 9600,
    "2022-01": 9850, "2022-02": 10000, "2022-03": 10300,
    "2022-04": 10150, "2022-05": 9350, "2022-06": 8500,
    "2022-07": 7600, "2022-08": 8000, "2022-09": 7650,
    "2022-10": 7600, "2022-11": 8200, "2022-12": 8400,
    "2023-01": 9100, "2023-02": 8900, "2023-03": 8900,
    "2023-04": 8700, "2023-05": 8200, "2023-06": 8400,
    "2023-07": 8600, "2023-08": 8400, "2023-09": 8200,
    "2023-10": 8000, "2023-11": 8300, "2023-12": 8500,
    "2024-01": 8400, "2024-02": 8500, "2024-03": 8800,
    "2024-04": 9600, "2024-05": 10400, "2024-06": 9800,
    "2024-07": 9400, "2024-08": 9100, "2024-09": 9600,
    "2024-10": 9500, "2024-11": 9200, "2024-12": 9000,
    "2025-01": 9100, "2025-02": 9300, "2025-03": 9500,
    "2025-04": 9400, "2025-05": 9600, "2025-06": 9500,
    "2025-07": 9450, "2025-08": 9400, "2025-09": 9350,
    "2025-10": 9400, "2025-11": 9450, "2025-12": 9500,
    "2026-01": 9550, "2026-02": 9600,
}

# ── 7. 한국은행 기준금리 (월간, step function) ─────────
KR_BASE_RATE_CHANGES = [
    ("2021-01", 0.50),
    ("2021-08", 0.75),
    ("2021-11", 1.00),
    ("2022-01", 1.25),
    ("2022-04", 1.50),
    ("2022-05", 1.75),
    ("2022-07", 2.25),
    ("2022-08", 2.50),
    ("2022-10", 3.00),
    ("2022-11", 3.25),
    ("2023-01", 3.50),
    ("2024-10", 3.25),
    ("2024-11", 3.00),
    ("2025-02", 2.75),
    ("2025-05", 2.50),
    ("2025-08", 2.25),
]

# ── 8. 한국 소비자물가지수 CPI (월간, 2020=100) ───────
KR_CPI_ANCHORS = {
    "2021-01": 101.2, "2021-02": 101.4, "2021-03": 101.9,
    "2021-04": 102.3, "2021-05": 102.6, "2021-06": 102.8,
    "2021-07": 103.1, "2021-08": 103.4, "2021-09": 103.4,
    "2021-10": 103.5, "2021-11": 103.7, "2021-12": 103.6,
    "2022-01": 104.1, "2022-02": 104.5, "2022-03": 105.0,
    "2022-04": 105.8, "2022-05": 106.5, "2022-06": 107.4,
    "2022-07": 107.8, "2022-08": 108.0, "2022-09": 108.3,
    "2022-10": 108.5, "2022-11": 108.3, "2022-12": 108.0,
    "2023-01": 108.5, "2023-02": 108.8, "2023-03": 109.1,
    "2023-04": 109.4, "2023-05": 109.7, "2023-06": 109.9,
    "2023-07": 110.2, "2023-08": 110.6, "2023-09": 111.0,
    "2023-10": 111.2, "2023-11": 111.0, "2023-12": 110.8,
    "2024-01": 111.3, "2024-02": 111.8, "2024-03": 112.1,
    "2024-04": 112.5, "2024-05": 113.0, "2024-06": 113.2,
    "2024-07": 113.8, "2024-08": 114.2, "2024-09": 114.0,
    "2024-10": 114.3, "2024-11": 114.5, "2024-12": 114.8,
    "2025-01": 115.2, "2025-02": 115.5, "2025-03": 115.8,
    "2025-04": 116.0, "2025-05": 116.2, "2025-06": 116.5,
    "2025-07": 116.8, "2025-08": 117.0, "2025-09": 117.2,
    "2025-10": 117.5, "2025-11": 117.7, "2025-12": 117.9,
    "2026-01": 118.2, "2026-02": 118.5,
}

# ── 9. 한국 제조업 생산지수 IPI (월간, 2020=100) ──────
KR_IPI_MFG_ANCHORS = {
    "2021-01": 103.5, "2021-02": 104.2, "2021-03": 107.8,
    "2021-04": 108.5, "2021-05": 107.3, "2021-06": 108.0,
    "2021-07": 107.1, "2021-08": 105.8, "2021-09": 106.5,
    "2021-10": 108.2, "2021-11": 108.8, "2021-12": 108.0,
    "2022-01": 107.5, "2022-02": 106.8, "2022-03": 109.0,
    "2022-04": 108.2, "2022-05": 108.5, "2022-06": 109.5,
    "2022-07": 107.8, "2022-08": 107.0, "2022-09": 107.5,
    "2022-10": 105.5, "2022-11": 103.8, "2022-12": 101.5,
    "2023-01": 99.0,  "2023-02": 100.2, "2023-03": 102.5,
    "2023-04": 101.8, "2023-05": 101.0, "2023-06": 101.5,
    "2023-07": 100.8, "2023-08": 102.0, "2023-09": 103.5,
    "2023-10": 104.0, "2023-11": 105.5, "2023-12": 105.0,
    "2024-01": 105.2, "2024-02": 106.0, "2024-03": 108.5,
    "2024-04": 109.0, "2024-05": 109.5, "2024-06": 110.8,
    "2024-07": 110.5, "2024-08": 110.0, "2024-09": 111.0,
    "2024-10": 110.8, "2024-11": 111.5, "2024-12": 111.0,
    "2025-01": 110.5, "2025-02": 111.0, "2025-03": 112.5,
    "2025-04": 112.0, "2025-05": 112.5, "2025-06": 113.0,
    "2025-07": 113.5, "2025-08": 113.0, "2025-09": 113.5,
    "2025-10": 114.0, "2025-11": 114.5, "2025-12": 114.0,
    "2026-01": 114.5, "2026-02": 115.0,
}

# ── 10. 중국 차이신 제조업 PMI (월간) ─────────────────
CN_PMI_MFG_ANCHORS = {
    "2021-01": 51.5, "2021-02": 50.9, "2021-03": 50.6,
    "2021-04": 51.9, "2021-05": 52.0, "2021-06": 51.3,
    "2021-07": 50.3, "2021-08": 49.2, "2021-09": 50.0,
    "2021-10": 50.6, "2021-11": 49.9, "2021-12": 50.9,
    "2022-01": 49.1, "2022-02": 50.4, "2022-03": 48.1,
    "2022-04": 46.0, "2022-05": 48.1, "2022-06": 51.7,
    "2022-07": 50.4, "2022-08": 49.5, "2022-09": 48.1,
    "2022-10": 49.2, "2022-11": 49.4, "2022-12": 49.0,
    "2023-01": 49.2, "2023-02": 51.6, "2023-03": 50.0,
    "2023-04": 49.5, "2023-05": 50.9, "2023-06": 50.5,
    "2023-07": 49.2, "2023-08": 51.0, "2023-09": 50.6,
    "2023-10": 49.5, "2023-11": 50.7, "2023-12": 50.8,
    "2024-01": 50.8, "2024-02": 50.9, "2024-03": 51.1,
    "2024-04": 51.4, "2024-05": 51.7, "2024-06": 51.8,
    "2024-07": 49.8, "2024-08": 50.4, "2024-09": 49.3,
    "2024-10": 50.3, "2024-11": 51.5, "2024-12": 50.5,
    "2025-01": 50.1, "2025-02": 50.8, "2025-03": 51.2,
    "2025-04": 50.4, "2025-05": 51.0, "2025-06": 50.7,
    "2025-07": 50.5, "2025-08": 50.9, "2025-09": 51.1,
    "2025-10": 50.8, "2025-11": 51.0, "2025-12": 50.6,
    "2026-01": 50.9, "2026-02": 51.2,
}


# ══════════════════════════════════════════════════════════
# 지표 정의 레지스트리
# ══════════════════════════════════════════════════════════

INDICATORS = {
    "sox": {
        "code": "SOX",
        "source": "MARKET",
        "name": "Philadelphia Semiconductor Index",
        "unit": "Index",
        "gen": lambda: generate_daily(SOX_ANCHORS, 0.012),
    },
    "dram": {
        "code": "DRAM_DDR4",
        "source": "MARKET",
        "name": "DRAM DDR4 8Gb Spot Price",
        "unit": "USD",
        "gen": lambda: generate_weekly(DRAM_ANCHORS, 0.025),
    },
    "nand": {
        "code": "NAND_TLC",
        "source": "MARKET",
        "name": "NAND Flash 128Gb TLC Spot Price",
        "unit": "USD",
        "gen": lambda: generate_weekly(NAND_ANCHORS, 0.020),
    },
    "wafer": {
        "code": "SILICON_WAFER",
        "source": "MARKET",
        "name": "Silicon Wafer 300mm ASP",
        "unit": "USD",
        "gen": lambda: generate_monthly(WAFER_ANCHORS, 0.005),
    },
    "baltic": {
        "code": "BALTIC_DRY",
        "source": "MARKET",
        "name": "Baltic Dry Index",
        "unit": "Index",
        "gen": lambda: generate_daily(BALTIC_DRY_ANCHORS, 0.035),
    },
    "copper": {
        "code": "COPPER_LME",
        "source": "MARKET",
        "name": "Copper LME Price",
        "unit": "USD/ton",
        "gen": lambda: generate_daily(COPPER_LME_ANCHORS, 0.010),
    },
    "kr_base_rate": {
        "code": "KR_BASE_RATE",
        "source": "BOK",
        "name": "Korea BOK Base Rate",
        "unit": "Percent",
        "gen": lambda: generate_stepwise_monthly(KR_BASE_RATE_CHANGES),
    },
    "kr_cpi": {
        "code": "KR_CPI",
        "source": "BOK",
        "name": "Korea Consumer Price Index",
        "unit": "Index 2020=100",
        "gen": lambda: generate_monthly(KR_CPI_ANCHORS, 0.001),
    },
    "kr_ipi": {
        "code": "KR_IPI_MFG",
        "source": "BOK",
        "name": "Korea Manufacturing Production Index",
        "unit": "Index 2020=100",
        "gen": lambda: generate_monthly(KR_IPI_MFG_ANCHORS, 0.005),
    },
    "cn_pmi": {
        "code": "CN_PMI_MFG",
        "source": "CHINA",
        "name": "China Caixin Manufacturing PMI",
        "unit": "Index",
        "gen": lambda: generate_monthly(CN_PMI_MFG_ANCHORS, 0.005),
    },
}


# ── 메인 ───────────────────────────────────────────────
def main():
    only_keys = None
    for arg in sys.argv[1:]:
        if arg.startswith("--only="):
            only_keys = set(arg.split("=", 1)[1].lower().split(","))

    print("=" * 60)
    print("외부 지수 데이터 생성 & Supabase 적재")
    print(f"기간: {START_DATE} ~ {END_DATE}")
    print(f"대상 테이블: economic_indicator")
    if only_keys:
        print(f"지표: {', '.join(only_keys)}")
    else:
        print(f"지표: {len(INDICATORS)}개 전체")
    print("=" * 60)

    start_all = time.time()
    total = 0
    results = {}

    for key, info in INDICATORS.items():
        if only_keys and key not in only_keys:
            continue

        code = info["code"]
        source = info["source"]
        name = info["name"]
        unit = info["unit"]

        print(f"\n  ▶ [{source}] {code} — {name}")

        try:
            data = info["gen"]()
            count = load_indicator(code, source, name, unit, data)
            results[code] = {"count": count, "source": source, "status": "OK"}
            print(f"    ✓ {count:,}건 적재")
            total += count
        except Exception as e:
            results[code] = {"count": 0, "source": source, "status": f"ERROR: {e}"}
            print(f"    ✗ 오류: {e}")

        time.sleep(0.5)

    # 결과 요약
    elapsed = time.time() - start_all
    print("\n" + "=" * 60)
    print("적재 결과 요약")
    print("=" * 60)
    print(f"{'지표 코드':<18} {'소스':<8} {'건수':>8} {'상태':<10}")
    print("-" * 50)
    for code, info in results.items():
        print(f"{code:<18} {info['source']:<8} {info['count']:>8,} {info['status']}")
    print("-" * 50)
    print(f"{'합계':<27} {total:>8,}")
    print(f"소요시간: {elapsed:.1f}s")
    print("=" * 60)


if __name__ == "__main__":
    main()
