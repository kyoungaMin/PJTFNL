# 개발일지 — 2026-02-28 (Day 2)

> **작성자**: kyoungaMin (kamin@penta.co.kr)
> **프로젝트**: 반도체 부품·소재 수요예측 AI SaaS

---

## 작업 목표
- 예측형 관제(Control Tower) 시스템 DB 스키마 설계 및 데이터 파이프라인 구축
- 매출 데이터를 출하 프록시로 사용, 일간 추정 재고 산출 로직 구현

## 작업 내역

| 시간 | 작업 내용 | 카테고리 | 상태 |
|------|----------|----------|------|
| — | GitHub 리포 멤버 공유 설정 안내 | `세팅` | `완료` |
| — | Supabase Organization 이전 (프로젝트 공유용) | `세팅` | `완료` |
| — | 예측형 관제 시스템 요건 vs 현재 데이터 충족 분석 | `데이터` | `완료` |
| — | 분석용 DDL 설계 (6테이블) — `06_analytics_ddl.sql` | `데이터` | `완료` |
| — | 파이프라인 공통 config 모듈 작성 | `데이터` | `완료` |
| — | S1: 일간 추정 재고 계산 파이프라인 | `데이터` | `완료` |
| — | S2: 제품별 리드타임 통계 산출 파이프라인 | `데이터` | `완료` |
| — | S3: 피처 엔지니어링 파이프라인 (내부 ERP + 외부지표 조인) | `데이터` | `완료` |
| — | S4: 수요예측 모델 파이프라인 (LightGBM Quantile / 이동평균 fallback) | `모델링` | `완료` |
| — | S5: 리스크 스코어링 파이프라인 (결품/과잉/납기/마진) | `모델링` | `완료` |
| — | S6: 조치 큐 생성 파이프라인 (권장 조치 자동 생성) | `모델링` | `완료` |
| — | 파이프라인 통합 실행기 작성 | `데이터` | `완료` |
| — | SCHEMA_REFERENCE.md 업데이트 (분석 테이블 6개 추가) | `문서` | `완료` |
| — | 월별 집계 쿼리 SQL 작성 (7종) — `07_queries/monthly_aggregation.sql` | `데이터` | `완료` |
| — | 주별·월별 집계 DDL 설계 (4테이블) — `08_aggregation_ddl.sql` | `데이터` | `완료` |
| — | S0: 주별·월별 집계 파이프라인 — `s0_aggregation.py` | `데이터` | `완료` |
| — | run_pipeline.py에 step 0 추가 | `데이터` | `완료` |
| — | SCHEMA_REFERENCE.md 업데이트 (집계 테이블 4개 추가, 23테이블 체계) | `문서` | `완료` |
| — | 환율 테이블 DDL 설계 — `09_exchange_rate_ddl.sql` | `데이터` | `완료` |
| — | 환율 데이터 생성/적재 스크립트 — `10_load_exchange_rate.py` | `데이터` | `완료` |
| — | 환율 데이터 적재 (USD/JPY/EUR/CNY → KRW, 5,321건) | `데이터` | `완료` |
| — | SCHEMA_REFERENCE.md 업데이트 (exchange_rate 테이블 추가, 25테이블 체계) | `문서` | `완료` |
| — | 반도체 산업 외부 지수 데이터 생성 스크립트 — `11_load_indices.py` | `데이터` | `완료` |
| — | 외부 지수 10종 적재 (SOX/DRAM/NAND/웨이퍼/BDI/구리/한국금리·CPI·IPI/중국PMI, 4,886건) | `데이터` | `완료` |
| — | SCHEMA_REFERENCE.md 업데이트 (외부 지수 10종 문서화) | `문서` | `완료` |
| — | README.md 작성 (프로젝트 전체 설명서, 제안서 기반) | `문서` | `완료` |
| — | ECOS(한국은행) API 연동 스크립트 — `12_load_ecos.py` | `데이터` | `완료` |
| — | ECOS 실데이터 10종 적재 (기준금리/CPI/IPI/BSI/PPI/환율/수출입물가/설비투자/재고, 1,810건) | `데이터` | `완료` |
| — | SCHEMA_REFERENCE.md 업데이트 (ECOS 연동 섹션 추가, economic_indicator ~10,285건) | `문서` | `완료` |
| — | customer_name 컬럼 추가 ALTER DDL — `08a_alter_customer_name.sql` | `데이터` | `완료` |
| — | customer_name backfill SQL 작성/실행 | `데이터` | `완료` |
| — | 주간 피처 스토어 DDL 설계 — `13_feature_store_weekly_ddl.sql` | `모델링` | `완료` |
| — | S3: 주간 피처 엔지니어링 전면 재작성 (~70개 피처, pandas 네이티브) | `모델링` | `완료` |
| — | S4: LightGBM v2 수정 (호라이즌별 별도 학습, early stopping, 정규화) | `모델링` | `완료` |
| — | config.py에 WEEKLY_FEATURE_COLS 상수 추가 | `모델링` | `완료` |
| — | SCHEMA_REFERENCE.md 업데이트 (feature_store_weekly 추가, 26테이블 체계) | `문서` | `완료` |
| — | S1: pandas 벡터화 리팩토링 (3중 루프→cumsum, 200개 제품 배치) | `리팩토링` | `완료` |
| — | S3: 재고/리드타임 인라인 계산 (S1/S2 의존 제거) | `리팩토링` | `완료` |
| — | S5: 재고/리드타임 인라인 계산 (inventory/purchase_order 직접 조회) | `리팩토링` | `완료` |
| — | 전체 파이프라인 실행 (S0~S6) 및 검증 | `데이터` | `완료` |
| — | scikit-learn 설치 (lightgbm.sklearn 의존성) | `세팅` | `완료` |
| — | LightGBM 모델 학습 완료 (4,280개 모델, 47,909건 예측) | `모델링` | `완료` |
| — | 리스크 스코어링 완료 (13,315개 제품, A~F 등급) | `모델링` | `완료` |
| — | 조치 큐 생성 완료 (4,000건, C등급 이상 1,936개 제품) | `모델링` | `완료` |
| — | 월간 피처 스토어 DDL 설계 — `14_feature_store_monthly_ddl.sql` | `모델링` | `완료` |
| — | S3m: 월간 피처 엔지니어링 (monthly_product_summary 기반, ~55개 피처) | `모델링` | `완료` |
| — | S4m: 월간 LightGBM 수요예측 (7,151개 모델, 24,482건 예측) | `모델링` | `완료` |
| — | config.py에 MONTHLY_FEATURE_COLS 상수 추가 (53개 피처 목록) | `모델링` | `완료` |
| — | run_pipeline.py에 step 3m, 4m 추가 (월간 파이프라인) | `데이터` | `완료` |
| — | SCHEMA_REFERENCE.md 업데이트 (feature_store_monthly 추가, 27테이블 체계) | `문서` | `완료` |

> **카테고리**: `세팅` `데이터` `모델링` `백엔드` `프론트` `인프라` `테스트` `문서` `리팩토링` `버그수정` `회의`

## 산출물
- `DB/06_analytics_ddl.sql` — 분석용 DDL (6테이블: daily_inventory_estimated, product_lead_time, feature_store, forecast_result, risk_score, action_queue)
- `DB/07_pipeline/config.py` — 파이프라인 공통 설정 (Supabase 연결, 배치 UPSERT, 리스크 가중치)
- `DB/07_pipeline/s1_daily_inventory.py` — 일간 추정 재고 산출 (월초 스냅샷 + 누적생산 - 누적출하)
- `DB/07_pipeline/s2_lead_time.py` — 리드타임 통계 (AVG/MED/P90/MIN/MAX)
- `DB/07_pipeline/s3_feature_store.py` — 피처 엔지니어링 (롤링 윈도우 + 외부지표 forward-fill)
- `DB/07_pipeline/s4_forecast.py` — 수요예측 모델 (LightGBM Quantile P10/P50/P90)
- `DB/07_pipeline/s5_risk_score.py` — 리스크 스코어링 (4유형 가중합, A~F 등급)
- `DB/07_pipeline/s6_action_queue.py` — 조치 큐 자동 생성 (C등급 이상)
- `DB/07_pipeline/run_pipeline.py` — 통합 실행기 (전체/스텝별 선택 실행)
- `DB/SCHEMA_REFERENCE.md` — 업데이트 (19테이블 체계)
- `DB/07_queries/monthly_aggregation.sql` — 월별 집계 쿼리 7종 (거래처별, 품목별, TOP 10, 점유율 등)
- `DB/08_aggregation_ddl.sql` — 주별·월별 집계 DDL (4테이블: weekly/monthly_product_summary, weekly/monthly_customer_summary)
- `DB/07_pipeline/s0_aggregation.py` — 주별·월별 집계 파이프라인 (수주+매출+생산 통합)
- `DB/SCHEMA_REFERENCE.md` — 업데이트 (23테이블 체계, 집계 테이블 추가)
- `DB/09_exchange_rate_ddl.sql` — 환율 DDL (exchange_rate 1테이블, 통화쌍별 일별 환율)
- `DB/10_load_exchange_rate.py` — 환율 데이터 생성/적재 (FRED API 실데이터 + 앵커 기반 생성)
- `DB/SCHEMA_REFERENCE.md` — 업데이트 (25테이블 체계, exchange_rate 추가)
- `DB/11_load_indices.py` — 반도체 산업 외부 지수 10종 생성/적재 (SOX, DRAM, NAND, 웨이퍼, BDI, 구리, 한국 금리·CPI·IPI, 중국 PMI)
- `DB/SCHEMA_REFERENCE.md` — 업데이트 (외부 지수 10종 문서화, economic_indicator ~8,475건)
- `README.md` — 프로젝트 전체 설명서 (배경, 핵심기능, 아키텍처, 파이프라인, 기술 스택, DB 구조, 목표, 로드맵)
- `DB/12_load_ecos.py` — ECOS 한국은행 API 연동 스크립트 (10종 지표, 실데이터)
- `DB/SCHEMA_REFERENCE.md` — 업데이트 (ECOS 연동 섹션 추가, economic_indicator ~10,285건 체계)
- `DB/08a_alter_customer_name.sql` — customer_name ALTER + backfill SQL
- `DB/13_feature_store_weekly_ddl.sql` — 주간 피처 스토어 DDL (feature_store_weekly, ~70 피처 + 타겟)
- `DB/07_pipeline/s3_feature_store.py` — 전면 재작성: 주간 피처 엔지니어링 (weekly_product_summary 기반, pandas 네이티브)
- `DB/07_pipeline/s4_forecast.py` — LightGBM v2 (호라이즌별 별도 학습, n_estimators=300, early stopping)
- `DB/07_pipeline/config.py` — WEEKLY_FEATURE_COLS 상수 추가 (65개 피처 목록)
- `DB/SCHEMA_REFERENCE.md` — 업데이트 (26테이블 체계, feature_store_weekly 추가)
- `DB/07_pipeline/s1_daily_inventory.py` — pandas 벡터화 리팩토링 (3중 루프→groupby+cumsum, 200개 제품 배치)
- `DB/07_pipeline/s3_feature_store.py` — 재고/리드타임 인라인 계산 (inventory/purchase_order 직접 조회)
- `DB/07_pipeline/s5_risk_score.py` — 재고/리드타임 인라인 계산 + 에러 핸들링 추가
- `DB/14_feature_store_monthly_ddl.sql` — 월간 피처 스토어 DDL (feature_store_monthly, ~55 피처 + 타겟)
- `DB/07_pipeline/s3m_feature_store_monthly.py` — 월간 피처 엔지니어링 (monthly_product_summary 기반)
- `DB/07_pipeline/s4m_forecast_monthly.py` — 월간 LightGBM 수요예측 (호라이즌별 별도 학습)
- `DB/07_pipeline/config.py` — MONTHLY_FEATURE_COLS 상수 추가 (53개 피처 목록)
- `DB/07_pipeline/run_pipeline.py` — step 3m, 4m 추가 (월간 파이프라인)
- `DB/SCHEMA_REFERENCE.md` — 업데이트 (27테이블 체계, feature_store_monthly 추가)

## 이슈/블로커
- S1(일간 추정 재고) 원본 코드: 3중 중첩 루프(600일×2,500제품×31일)로 수 시간 소요 → pandas cumsum으로 리팩토링
- S3/S5가 S1(daily_inventory_estimated)/S2(product_lead_time) 테이블에 의존하여 실행 순서 강제 → 인라인 계산으로 의존성 제거

## 의사결정 기록

| 결정 사항 | 선택지 | 결정 | 사유 |
|-----------|--------|------|------|
| 출하 데이터 대체 | 별도 출하 테이블 / 매출 대체 | 매출(daily_revenue) 대체 | B2B 반도체 특성상 출하≈매출 래그 미미, 주간 집계 시 흡수 |
| 일간 재고 산출 | DB 뷰 / Python 계산 테이블 | Python 계산 → 테이블 적재 | 월초 스냅샷 기반 일간 보간, 복잡한 누적 로직 Python이 유연 |
| 예측 모델 | Prophet / ARIMA / LightGBM Quantile | LightGBM Quantile | P10/P50/P90 밴드 직접 산출, 외부 피처 활용 용이, 이동평균 fallback 포함 |
| 리스크 가중치 | 균등 / 불균등 | 불균등 (결품35%/과잉25%/납기25%/마진15%) | 제조업 특성상 결품 리스크가 가장 치명적 |
| 조치 큐 생성 기준 | 전체 / C등급 이상 | C등급 이상 (total_risk > 40) | 과다 알림 방지, 운영 실효성 |
| 피처 스토어 단위 | 일별(daily) / 주별(weekly) | **주별(weekly)** | B2B 반도체 수주 주기(3~4주), 일별 희소성 해소, weekly_product_summary 활용 |
| 타겟 변수 설계 | 과거 롤링합(order_qty_7d) / forward-shift | **forward-shift (target_1w/2w/4w)** | 기존 과거 롤링합→정보 누수, forward-shift로 정상적 시계열 예측 |
| 피처 수 확장 | 18개 유지 / 70개 확장 | **~70개 확장** | 래그, 변동성, 반도체지표(SOX/DRAM/NAND), 고객집중도, ECOS 등 추가 |
| S1 성능 | 원본 3중 루프 / pandas 벡터화 | **pandas cumsum+배치** | 원본 수 시간→수 분으로 단축, 200개 제품 단위 메모리 관리 |
| S3/S5 의존성 | S1/S2 테이블 의존 / 인라인 계산 | **인라인 계산** | 파이프라인 단계 건너뛰기 가능, inventory/purchase_order 직접 조회 |
| 월간 피처 스토어 | 주간만 / 주간+월간 | **주간+월간 병행** | 주간=단기 운영, 월간=중장기 전략 예측 |
| 월간 래그/윈도우 | 주간과 동일 / 월 단위 변환 | **월 단위 변환** | lag1/2/3/6/12개월, MA3/6/12, 타겟 1m/3m/6m |
| 월간 모델 | n_estimators=300 / 200 | **200** | 월간 데이터량이 주간의 ~60%로 적어 과적합 방지 |

## 내일 할 일
- [x] ~~Supabase SQL Editor에서 `13_feature_store_weekly_ddl.sql` 실행~~
- [x] ~~파이프라인 실행 테스트 (step 0~6 순차)~~
- [x] ~~lightgbm 패키지 설치 및 모델 학습 검증~~
- [ ] 예측 결과 시각화 (P10/P50/P90 밴드 차트)
- [ ] LightGBM feature importance 분석
- [ ] 예측 정확도 평가 (MAPE, RMSE, Quantile Loss)

## 메모
- 파이프라인 실행 전 반드시 DDL을 Supabase SQL Editor에서 먼저 실행해야 함 (`06_analytics_ddl.sql` + `08_aggregation_ddl.sql`)
- lightgbm 미설치 시 이동평균 fallback으로 동작
- 리스크 가중치는 추후 운영 데이터 기반 튜닝 필요
- `daily_revenue.customer_id` → `supplier.customer_code` 매핑 (customer 테이블이 아님)
- 피처 스토어 일별→주별 전환: 희소성 해결 + 7배 데이터 감소 + weekly_product_summary 재활용
- 타겟 forward-shift: target_1w(T+1주), target_2w(T+1~2주), target_4w(T+1~4주)
- 반도체 시장 지표(SOX/DRAM/NAND) 추가 → LightGBM feature importance 기대
- 파이프라인 전체 실행 결과:
  - S3(피처): 83,719행, 1,560개 제품, 69개 피처
  - S4(예측): 4,280개 모델(1,560 제품 × ~3 호라이즌), 47,909건 예측
  - S5(리스크): 13,315개 제품 (A:3,715 / B:7,651 / C:1,884 / D:48 / F:17)
  - S6(조치): 4,000건 (critical:2,656 / high:1,322 / medium:22)
- S3/S5에서 inventory/purchase_order 직접 조회로 S1/S2 선행 불필요
- 월간 파이프라인 실행 결과:
  - S3m(피처): 48,416행, 3,148개 제품, 62개 피처
  - S4m(예측): 7,151개 모델(3,148 제품 × ~3 호라이즌), 24,482건 예측
  - forecast_result 합산: 72,391행 (주간 47,909 + 월간 24,482)
- 월간 파이프라인 실행: `--step=3m,4m`
